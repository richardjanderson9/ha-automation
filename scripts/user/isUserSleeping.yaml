alias: is_user_sleeping.yaml
sequence:
  - if:
      # Use logical AND to ensure all sensors confirm a sleeping state
      - condition: and
        conditions:
          # Check if current time is within the defined sleep window
          - condition: time
            after: "21:00:00"
            before: "09:00:00"
          
          # Check if the watch has been manually set to Bedtime Mode
          - condition: state
            entity_id: binary_sensor.watch_bedtime_mode
            state: "on"
          
          # Verify phone sensor reports sleep confidence higher than 50%
          - condition: numeric_state
            entity_id: sensor.phone_sleep_confidence
            above: 50
          
          # Confirm the bedroom light is off to avoid false positives while awake
          - condition: state
            entity_id: light.bedroom_light
            state: "off"
            
    then:
      # Actions to take when all sleep conditions are TRUE
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.is_sleeping
          
      - action: logbook.log
        data:
          name: "Sleep Logic"
          message: "Conditions met: Setting Sleep Mode to ON"
          
    else:
      # Actions to take when any condition is FALSE (Awake or outside sleep window)
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.is_sleeping
          
      - action: logbook.log
        data:
          name: "Sleep Logic"
          message: "Conditions not met: Setting Sleep Mode to OFF"